{% extends 'base.html' %}
{% load static %}
{% block title %}–ú–∞–ø–∞ –õ–æ–∫–∞—Ü—ñ—ó{% endblock %}

{% block content %}

<div id="searchContainer">
    <form id="searchForm" method="GET" action="{% url 'book' %}">
        <label for="searchInput"></label>
        <input
            type="text"
            id="searchInput"
            name="q"
            placeholder="–í–≤–µ–¥—ñ—Ç—å –Ω–∞–∑–≤—É –ª–æ–∫–∞—Ü—ñ—ó –∞–±–æ –∫–Ω–∏–≥–∏..."
            value="{{ query|default_if_none:'' }}"
            autocomplete="off"
        >
        <button type="submit">–ü–æ—à—É–∫</button>
    </form>
</div>

<div class="map-container">
    <div id="map"></div>

    <div id="bookList">
        <h2>–°–ø–∏—Å–æ–∫ –∫–Ω–∏–≥</h2>
        <div id="bookListContent">
            <p>–¢—É—Ç –±—É–¥–µ —Å–ø–∏—Å–æ–∫ –∫–Ω–∏–≥...</p>
        </div>
    </div>
</div>

<div id="info-table" class="info-table"></div>

<link rel="stylesheet" href="{% static 'library_app/css/map.css' %}">
<script src="https://api.mapbox.com/mapbox-gl-js/v3.10.0/mapbox-gl.js"></script>
<link href="https://api.mapbox.com/mapbox-gl-js/v3.10.0/mapbox-gl.css" rel="stylesheet" />

<script>
    mapboxgl.accessToken = 'pk.eyJ1IjoibWFybC1rYXJreCIsImEiOiJjbTM4ajBzMWcwcThxMmxyNjJsem0yend3In0.Y3IxtbjjnT5nSpfgZyR9ZQ';
    const map = new mapboxgl.Map({
        container: 'map',
        style: 'mapbox://styles/marl-karkx/cm50vmhnn009i01sag0oka2vx',
        center: [24.030, 49.839],
        zoom: 11.90
    });

    map.addControl(new mapboxgl.NavigationControl());
    map.addControl(new mapboxgl.GeolocateControl({
        positionOptions: { enableHighAccuracy: true },
        trackUserLocation: true
    }));

    // –ü—Ä–∏–∫–ª–∞–¥ geojson (–≤—Å—Ç–∞–≤—Ç–µ –≤–∞—à)
    var geojson = {{ geojson|safe }};
    const infoTable = document.getElementById('info-table');

    // –§—É–Ω–∫—Ü—ñ—è, —â–æ –ø–æ–∫–∞–∑—É—î –ø—Ä–∞–≤—É –∫–æ–ª–æ–Ω–∫—É –∑—ñ —Å–ø–∏—Å–∫–æ–º –∫–Ω–∏–≥
    function showBookList() {
        // –ó–∞–º—ñ—Å—Ç—å –ø–µ—Ä–µ—Ö–æ–¥—É –∑–∞ –ø–æ—Å–∏–ª–∞–Ω–Ω—è–º ‚Äì –ø—Ä–æ—Å—Ç–æ —Ä–æ–±–∏–º–æ –±–ª–æ–∫ –≤–∏–¥–∏–º–∏–º
        document.getElementById('bookList').style.display = 'block';
    }

    map.on('load', function () {
        map.addSource('bookstores', {
            'type': 'geojson',
            'data': geojson
        });

        // –ó–∞–≤–∞–Ω—Ç–∞–∂—É—î–º–æ —ñ–∫–æ–Ω–∫—É
        map.loadImage('{% static "library_app/images/icon.jpg" %}', function (error, image) {
            if (error) throw error;
            map.addImage('bookstore-icon', image);

            map.addLayer({
                'id': 'bookstores-layer',
                'type': 'symbol',
                'source': 'bookstores',
                'layout': {
                    'icon-image': 'bookstore-icon',
                    'icon-size': 0.1,
                    'icon-anchor': 'bottom',
                }
            });
        });

        map.on('mouseenter', 'bookstores-layer', function (e) {
            map.getCanvas().style.cursor = 'pointer';
            const properties = e.features[0].properties;

            // –í—ñ–¥–æ–±—Ä–∞–∂–∞—î–º–æ —Ç–∞–±–ª–∏—á–∫—É
            infoTable.style.display = 'block';
            infoTable.innerHTML = `
                <table border="1">
                    <tr>
                        <th colspan="2">${properties.name}</th>
                    </tr>
                    <tr>
                        <td>üìç –ê–¥—Ä–µ—Å–∞</td>
                        <td>${properties.address}</td>
                    </tr>
                    <tr>
                        <td>üïí –ì—Ä–∞—Ñ—ñ–∫</td>
                        <td>${properties.work_schedule}</td>
                    </tr>
                    <tr>
                        <td>
                            <img src="{% static 'library_app/images/instagram_icon.png' %}" alt="Instagram Icon" style="width: 15px; height: 15px; vertical-align: middle;">
                            <a href="${properties.instagram_link}" target="_blank" class="instagram-link">–Ü–Ω—Å—Ç–∞–≥—Ä–∞–º</a>
                        </td>
                        <!--
                            –ó–∞–º—ñ—Å—Ç—å href="http://127.0.0.1:8000/books/" —Ä–æ–±–∏–º–æ href="#"
                            —ñ –≤–∏–∫–ª–∏–∫–∞—î–º–æ showBookList(), —â–æ–± –≤—ñ–¥–∫—Ä–∏—Ç–∏ –ø—Ä–∞–≤–∏–π –±–ª–æ–∫
                        -->
                        <td>
                            <a href="#" class="book-link" onclick="showBookList()">üìö –°–ø–∏—Å–æ–∫ –∫–Ω–∏–≥</a>
                        </td>
                    </tr>
                </table>
            `;

            // –ü–æ–∑–∏—Ü—ñ—é—î–º–æ —Ç–∞–±–ª–∏—á–∫—É –±—ñ–ª—è –∫—É—Ä—Å–æ—Ä–∞
            infoTable.style.left = (e.point.x - 150) + 'px';
            infoTable.style.top = (e.point.y + 40) + 'px';
        });

        map.on('click', 'bookstores-layer', function (e) {
            infoTable.style.display = 'none'
            // –ó–∞ –∞–Ω–∞–ª–æ–≥—ñ—î—é –º–æ–∂–Ω–∞ –¥–æ–¥–∞—Ç–∏/–∑–º—ñ–Ω–∏—Ç–∏ —Ñ—É–Ω–∫—Ü—ñ–æ–Ω–∞–ª –ø—Ä–∏ –∫–ª—ñ–∫—É
        });

        // –©–æ–± –∫–∞—Ä—Ç–∞ –Ω–µ –æ–±—Ä—ñ–∑–∞–ª–∞—Å—è –ø—Ä–∏ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—ñ
        window.addEventListener('load', function() {
            map.resize();
        });
    });
</script>

{% endblock %}
